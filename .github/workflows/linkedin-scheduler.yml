name: LinkedIn Post Scheduler

on:
  schedule:
    # Daily at 8:05 AM PST (16:05 UTC) - 7-day rotation starting Feb 1
    - cron: '5 16 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual posting)'
        required: false
        default: 'false'
        type: boolean
      filename:
        description: 'Specific post filename (optional, without .md)'
        required: false
        type: string

env:
  LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
  LINKEDIN_PERSON_URN: ${{ secrets.LINKEDIN_PERSON_URN }}

jobs:
  post-to-linkedin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get next post from rotation
        id: get-post
        run: |
          # Read or initialize rotation index
          INDEX_FILE="genAI/linkedin-7day/.current-index"
          if [ -f "$INDEX_FILE" ]; then
            CURRENT_INDEX=$(cat "$INDEX_FILE")
          else
            CURRENT_INDEX=0
          fi

          # Get sorted list of posts
          POSTS=($(ls -1 genAI/linkedin-7day/*.md 2>/dev/null | sort))
          TOTAL=${#POSTS[@]}

          if [ $TOTAL -eq 0 ]; then
            echo "No posts available in linkedin-7day"
            echo "has_post=false" >> $GITHUB_OUTPUT
          else
            # Wrap index to cycle through posts
            CURRENT_INDEX=$((CURRENT_INDEX % TOTAL))
            SELECTED="${POSTS[$CURRENT_INDEX]}"
            FILENAME=$(basename "$SELECTED" .md)
            echo "Found post [$((CURRENT_INDEX + 1))/$TOTAL]: $FILENAME"
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "has_post=true" >> $GITHUB_OUTPUT
            echo "next_index=$((CURRENT_INDEX + 1))" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no posts
        if: steps.get-post.outputs.has_post == 'false'
        run: |
          echo "No posts in linkedin-7day rotation. Skipping."
          exit 0

      - name: Post to LinkedIn
        if: steps.get-post.outputs.has_post == 'true'
        id: post
        env:
          POST_FILENAME: ${{ github.event.inputs.filename || steps.get-post.outputs.filename }}
          LINKEDIN_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          LINKEDIN_POSTS_DIR: genAI/linkedin-7day
        run: |
          echo "Posting: $POST_FILENAME"
          echo "Dry run: $LINKEDIN_DRY_RUN"

          # Build dry-run flag if needed
          DRY_RUN_FLAG=""
          if [ "$LINKEDIN_DRY_RUN" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          # Run CLI and capture output
          npm run linkedin -- post --file "$POST_FILENAME" --visibility PUBLIC --json $DRY_RUN_FLAG > result.json 2>&1 || true

          cat result.json

          # Check for success
          if grep -q '"success":true' result.json; then
            echo "Successfully posted: $POST_FILENAME"
            echo "success=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Failed to post"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Update rotation index
        if: steps.get-post.outputs.has_post == 'true' && steps.post.outputs.success == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Updating rotation index to: ${{ steps.get-post.outputs.next_index }}"

          # Write next index (will wrap on next run)
          echo "${{ steps.get-post.outputs.next_index }}" > genAI/linkedin-7day/.current-index

          # Commit the index update
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add genAI/linkedin-7day/.current-index
          git diff --staged --quiet || git commit -m "Update LinkedIn rotation index"
          git push

      - name: Summary
        if: always()
        run: |
          echo "## LinkedIn Post Scheduler Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.get-post.outputs.has_post }}" = "true" ]; then
            echo "- **Post:** ${{ github.event.inputs.filename || steps.get-post.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Next Index:** ${{ steps.get-post.outputs.next_index }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Success:** ${{ steps.post.outputs.success || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** No posts in linkedin-7day rotation" >> $GITHUB_STEP_SUMMARY
          fi
